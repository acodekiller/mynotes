# 一、MySQL体系结构和存储引擎

## 1、数据库和实例

数据库：物理操作系统文件或其他形式文件类型的集合。

实例：MySQL数据库由后台线程以及一个共享内存区组成。

> 在MySQL数据库中，实例与数据库的关通常系是一一对应的，即一个实例对应一个数据库，一个数据库对应一个实例。但是，在集群情况下可能存在一个数据库被多个数据实例使用的情况。

## 2、体系结构

![image-20220525231725967](imgs/image-20220525231725967.png)

- **连接池：**管理、缓冲用户的连接；
- **管理服务和工具组件：**系统管理和控制工具，如备份恢复、MySQL复制、集群等；
- **SQL接口组件：**接受用户的SQL命令，并且返回用户需要的查询结果；
- **查询分析器组件：**SQL命令传递到解析器时会被解析器验证和解析（权限、语法结构）；
- **优化器组件：**SQL语句在查询前会使用查询优化器进行优化；
- **缓冲组件：**如果查询缓存命中查询结果，查询语句可以从这里获得结果；
- **插件式存储引擎**
- **物理文件**

**存储引擎式基于表的，而不是数据库。**

## 3、存储引擎

### 1）InnoDB

InnoDB存储引擎支持事务，其设计目标主要面向在线事务处理（OLTP）的应用。其特点是行锁设计、支持外键，并支持类似于Oracle的非锁定读，即默认读取操作不会产生锁。

InnoDB通过使用多版本并发控制（MVCC）来获得高并发性，并且实现了SQL标准的4种隔离级别，默认为REPEATABLE级别。

对于表中数据的存储，InnoDB存储引擎采用了聚集（clustered）的方式，因此每张表的存储都是按主键的顺序进行存放。

### 2）MyISAM

MyISAM存储引擎不支持事务、表锁设计，支持全文索引，主要面向一些OLAP数据库应用。

MyISAM存储引擎表由MYD和MYI组成，MYD用来存放数据文件，MYI用来存放索引文件。

### 3）Memory

将表中的数据存放在内存中，如果数据库重启或发生崩溃，表中的数据都将消失。它非常适合用于存储临时数据的临时表，以及数据仓库中的纬度表。Memory存储引擎默认使用哈希索引，而不是我们熟悉的B+树索引。

只支持表锁，并发性能较差，并且不支持TEXT和BLOB列类型。最重要的是，存储变长字段（varchar）时是按照定常字段（char）的方式进行的，因此会浪费内存。

# 二、InnoDB存储引擎

## 1、InnoDB 体系结构

![image-20220414180326882](imgs/image-20220414180326882.png)

### 1）后台线程

1. **Master Thread：**非常核心的后台线程，主要负责将缓冲池中的数据异步刷新到磁盘，保证数据的一致性。
2. **IO Thread：**主要负责IO请求的回调处理，包含write、read、insert buffer 和 log IO Thread。
3. **Purge Thread：**回收已经使用分配的undo页，如：事务提交后，其所使用的undolog可能不再需要了。
4. **Page Cleaner Thread：**处理脏页的刷新。

> 查看版本：`SHOW VARIABLES LIKE 'innodb_version'\G;`
>
> 查看状态：`SHOW INNODB STATUS\G;`

### 2）内存

![image-20220414180055038](imgs/image-20220414180055038.png)

1. **缓冲池：**缓冲池其实是一块内存区域，通过内存的速度来弥补磁盘速度较慢对数据性能的影响。

> **InnoDB存储引擎的内存管理**
>
> - LRU List：LRU列表用来管理已经读取的页。
> - Free List：LRU列表用来管理已经读取的页，但当数据库刚启动时，LRU列表是空的，即没有任何的页。这时页都存放在Free列表中。当需要从缓冲池中分页时，首先从Free列表中查找是否有可用的空闲页，若有则将该页从Free列表中删除，放入到LRU列表中。否则，根据LRU算法，淘汰LRU列表末尾的页，将该内存空间分配给新的页。
> - Flush List：在LRU列表中的页被修改后，称该页为脏页（dirty page），即缓冲池中的页和磁盘上的页的数据产生了不一致。Flush列表中的页即为脏页列表。需要注意的是，脏页既存在于LRU列表中，也存在于Flush列表中。LRU列表用来管理缓冲池中页的可用性，Flush列表用来管理将页刷新回磁盘，二者互不影响。

2. **重做日志缓冲：**InnoDB存储引擎首先将重做日志信息先放入到这个缓冲区，然后按一定频率将其刷新到重做日志文件。只需要保证每秒产生的事务量再这个缓冲大小之内即可。8MB的重做日志缓冲池足以满足绝大部分的应用。

> **以下三种情况会将重做日志缓冲中的内容刷新到外部磁盘的重做日志文件中：**
>
> 1. Master Thread 每一秒将重做日志缓冲刷新到重做日志文件；
> 2. 每个事务提交时会将重做日志缓冲刷新到重做日志文件；
> 3. 当重做日志缓冲池剩余空间小于1/2时，重做日志缓冲刷新到重做日志文件。

3. **额外的内存池：**在对一些数据结构本身的内存进行分配时，需要从而外的内存池中进行申请，当该区域的内存不够时，会从缓冲池中进行申请。

## 2、Checkpoint技术

### 1）目的

- **缩短数据库的恢复时间：**当数据库发生宕机时，数据库不需要重做所有的日志，因为Checkpoint之前的页都已经刷新回磁盘。故数据库只需对Checkpoint后的重做日志进行恢复。这样就大大缩短了恢复的时间；
- **缓冲池不够用时，将脏页刷新到磁盘：**当缓冲池不够用时，根据LRU算法会溢出最近最少使用的页，若此页为脏页，那么需要强制执行Checkpoint，将脏页也就是页的新版本刷回磁盘；
- **重做日志不可用时，刷新脏页：**重做日志出现不可用的情况是因为当前事务数据库系统对重做日志的设计都是循环使用的，并不是让其无限增大的，这从成本及管理上都是比较困难的。重做日志可以被重用的部分是指这些重做日志已经不再需要，即当数据库发生宕机时，数据库恢复操作不需要这部分的重做日志，因此这部分就可以被覆盖重用。若此时重做日志还需要使用，那么必须强制产生Checkpoint，将缓冲池中的页至少刷新到当前重做日志的位置。

### 2）种类

1. **Sharp Checkpoint：**发生在数据库关闭时将所有的脏页都刷新到磁盘，这是默认的工作方式；
2. **Fuzzy Checkpoint：**只刷新一部分脏页。
   1. Master Thread Checkpoint：刷新一定比列的页回磁盘（异步过程，不会阻塞用户线程）；
   2. FLUSH_LRU_LIST Checkpoint：保证一定数量的空闲页可用，会阻塞用户的查询操作；
   3. Async/Sync Flush Checkpoint：保证重做日志的循环使用的可用性；
   4. Dirty Page too much Checkpoint：保证缓冲池有足够可用的页。

# 三、文件

## 1、参数文件

1.  **含义：**当MySQL实例启动时，数据库会先去读一个配置参数文件，用来寻找数据库的各种文件所在位置以及指定某些初始化参数。
2. **类型：**
   - 动态参数：可以在MySQL实例运行中进行修改；
   - 静态参数：在整个实例生命周期内都不能更改，就好像时只读的；
   - session：表明该参数的修改是基于当前会话的；
   - gloabal：表明该参数的修改是基于整个实例的生命周期；

## 2、日志文件

### 1）错误日志

在遇到问题时首先查看该文件以便定位问题，该文件不仅记录了所有的错误信息，也记录一些警告信息和正确的信息。

### 2）慢查询日志

慢查询日志可帮助DBA定位可能存在问题的SQL语句，从而进行SQL语句层面的优化。可以使用show variables like ‘slow_query_log’查看是否开启，如果状态值为OFF，可以使用set GLOBAL slow_query_log = on来开启，它会在datadir下产生一个【主机名】-slow.log的文件。

- 查看阈值：`show VARIABLES like 'long_query_time'`
- 设置阈值：`set long_query_time=0.5`（大于0.5秒的SQL语句，正好等于long_query_time并不会被记录）

### 3）查询日志

记录了所有对MySQL数据库请求的信息。

### 4）二进制日志

1. 含义：二进制日志记录了对MySQL数据库执行更改的所有操作，即使这些操作并没有导致数据库发生变化。默认情况下是不开启的。
2. 作用：某些数据的恢复需要二进制日志；用作主从同步；判断是否有对数据库进行注入的攻击。
3. 记录格式：statement、row、mixed。

## 3、套接子文件

在UNIX系统下本地连接MySQL可以采用UNIX域套接字方式，这种方式需要一个套接字文件。

## 4、pid文件

当MySQL实例启动时，会将自己的进程ID写入到一个文件中——该文件即为pid文件。

## 5、表结构定义文件

MySQL数据的存储时根据表进行的，每个表都会有与之对应的文件，但不论表采用何种存储引擎，MySQL都有一个以frm为后缀的文件，这个文件记录了该表的表结构定义。

## 6、InnoDB存储引擎文件

### 1）表空间文件

InnoDB采用将存储的数据按表空间（tablespace）进行存放的设计，如果设置了`innodb_data_file_path`参数，所有基于InnoDB存储引擎的表的数据都会记录到该共享表空间中。若设置了`innodb_file_per_table`，则用户可以将每个基于InnoDB存储引擎的表产生一个独立表空间。独立表空间的命名规则为：表名.ibd。通过这样的方式，用户不用将所有数据都存放于默认的表空间中。

### 2）重做日志文件

当实例或介质失败时，重做日志文件就能派上用场。

重做日志文件的大小设置对于InnoDB存储引擎的性能有着非常大的影响。一方面重做日志文件不能设置得太大，如果设置得很大，在恢复时可能需要很长的时间；另外一方面又不能设置得太小了，否则可能导致一个事务得日志需要多次切换重做日志文件。此外，重做日志文件太小会导致频繁地发生async checkpoint，导致性能地抖动。

